<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />

	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script src="http://www.hivemq.com/demos/websocket-client/js/mqttws31.js"></script>
	<script src="http://shawnchin.github.io/jquery-cron/cron/jquery-cron.js"></script>

</head>
<body>


	<div data-role="page" data-transition="slide" id="main">
		<div data-role="header"  data-theme="b">
			<h1>SonOFF Control</h1>
			<a href="#setup" data-icon="gear" class="ui-btn-right">Options</a>

		</div>
		<div class="ui-body ui-body-a ui-corner-all">

		</div>
	</div>
	<!-- setup -->
	<div data-role="page" data-transition="slide" id="setup">
		<div data-role="header"  data-theme="b">
			<a href="#main" data-icon="back" class="ui-btn-left">Back</a>

			<h1>SonOFF Config</h1>
		</div>
		<div class="ui-body ui-body-a ui-corner-all">
			<input id="mosquitto" placeholder="mosquitto">
			<input id="user" placeholder="user:password">
			<input id="rootd" placeholder="rootd">
			<hr>
			<input id="name0" placeholder="name">
			<input id="name1" placeholder="name">
			<input id="name2" placeholder="name">
			<input id="name4" placeholder="name">
			<button id="oksetup">Ok</button>

		</div>
	</div>
	<!-- Timer/action -->
	<div data-role="page" data-transition="slide" id="param">
		<div data-role="header"  data-theme="b">
			<h1>SonOFF Controller</h1>
		</div>

		<div data-role="collapsible" data-theme="b">
			<h4>Countdown</h4>
			<input type="range" name="slider-1" id="slider-1" min="10" max="1800" value="900">

			<div class="ui-grid-d ui-responsive">
				<div class="ui-block-a">
					<select id="onoff" data-shadow="false">
						<option value="on">On</option>
						<option value="off">Off</option>
					</select>
				</div>


				<div class="ui-block-c">
					<div id="custom-border-radius" style="float:right">
						<a href="#main" class="ui-btn ui-icon-check ui-btn-icon-notext ui-corner-all ui-btn-b" id="countdown">No text</a>
					</div>
				</div>
				<div class="ui-block-d">
					<div id="custom-border-radius" style="float:right" >
						<a href="#main" class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all ui-btn-b" >No text</a>
					</div>
				</div>


			</div>
		</div>

		<div data-role="collapsible" data-theme="b">
			<h4>Crontab</h4>

			<div class="ui-grid-c ui-responsive">
				<div class="ui-block-a">
					<div id='selector'></div>
					<input id='cronmask'>
				</div>
				<div class="ui-block-b">
					<select id="Conoff" data-shadow="false">
						<option value="on">On</option>
						<option value="off">Off</option>
					</select>
				</div>

				<div class="ui-block-c">

					<div id="custom-border-radius" style="float:right">
						<a href="#main" class="ui-btn ui-icon-check ui-btn-icon-notext ui-corner-all ui-btn-b" id="crontab">No text</a>
					</div>
				</div>

				<div class="ui-block-d">
					<div id="custom-border-radius" style="float:right" >
						<a href="#main" class="ui-btn ui-icon-delete ui-btn-icon-notext ui-corner-all ui-btn-b" >No text</a>
					</div>
				</div>

			</div>
		</div>

		<div data-role="collapsible" data-theme="b">
			<h4>Reboot</h4>
			<a href="#" id="restart" class="ui-shadow-icon ui-btn ui-shadow ui-corner-all ui-btn-b ui-icon-refresh ui-btn-icon-left">restart</a>
		</div>

		<a href="#main" class="ui-btn ui-icon-delete ui-btn-icon-right">back</a>


	</div>

	<script>
	var wifi;

	var MOSQUITTO;
	var NAME;
	var DEVICES;
	var USER;
	var ROOT;

	var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9+/=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/rn/g,"n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}


	$(function() {

		var client;

		if (typeof(Storage) !== "undefined")
		{
			if (localStorage.mosquitto==undefined) {
				$("body").pagecontainer("change", "#setup");


			}

			else {
				MOSQUITTO=localStorage.mosquitto;
				NAME=localStorage.name;
				DEVICES=JSON.parse(localStorage.device);
				USER=localStorage.cred;
				ROOT=localStorage.root;

				$("#mosquitto").val(MOSQUITTO);
				$("#user").val(USER);
				$("#rootd").val(ROOT);

		$.each(DEVICES,function(i,v) {
			$("#name"+i).val(v);	
		});

				if (location.href.split("#")[1]=="setup")
				$("body").pagecontainer("change", "#main");

			}
		}


		$("#oksetup").click(function(){


			device=[];
			device[0]=$("#name0").val();
			device[1]=$("#name1").val();
			device[2]=$("#name2").val();
			device[3]=$("#name3").val();

			localStorage.device=JSON.stringify(device);
			localStorage.mosquitto=$("#mosquitto").val();
			localStorage.name=$("#name0").val();
			localStorage.cred=$("#user").val();
			localStorage.root=$("#rootd").val();

			location.href=location.href.split("#")[0];
		});


		$('#selector').cron({
			onChange: function() {
				$('#cronmask').val($(this).cron("value"));}
			});

			if (MOSQUITTO) {

				client= new Messaging.Client(MOSQUITTO.split(":")[0],parseInt(MOSQUITTO.split(":")[1]), "test"+ parseInt(Math.random() * 100, 10));
				var options = {
					userName: USER.split(":")[0],
					password: USER.split(":")[1],
					timeout: 3,
					onSuccess: function () {
						$.each(DEVICES,function(i,value){

							if (value)
							client.subscribe(ROOT+value+"/#", {qos: 0});
						});

					},
					onFailure: function (message) {
						alert("Connection failed: " + message.errorMessage);
					}
				};


				$.each(DEVICES, function(i,value) {


					if (value) {
						devname=value;
						$("<div/>", {class:"ui-body ui-body-a ui-corner-all"})
						.append($("<label>Device  "+devname+"</label>"))
						.append($("<select>",{id:devname,'data-role':"flipswitch",'data-theme':"b"}))
						.append($("<a/>",
						{
							class:"ui-btn ui-icon-clock ui-btn-icon-notext ui-corner-all ui-btn-b",
							style:"float:right",
							href:"#param",
							'name':value
						}))
						.appendTo("#main");

						flipChanged=function(e) {
							id = this.id,
							value = this.value;
							if (this.value=="on") publish("1",ROOT+id+"/set",0)
							else publish("0",ROOT+id+"/set",0)
						}
						$("#"+devname).on("change", flipChanged);
						$("a").click(function(e) {
							localStorage.param=e.target.name;
							console.log(e.target.name)});

						}

					});

					$("select[data-role='flipswitch']").append($("<option />",{value:"off",text:"Off"}))
					$("select[data-role='flipswitch']").append($("<option />",{value:"on",text:"On"}))
					$("select[data-role='flipswitch']").flipswitch();


					activateswitch=function()
					{
						//	$("#flip-2").flipswitch();

						client.onMessageArrived = function (message) {
							console.log(message.destinationName+" "+message.payloadString);
							tb=message.destinationName.split("/");
							eventtype=tb[tb.length-1];
							nom=tb[tb.length-2];


							if (eventtype=="relais")
							{

								$("#"+nom)
								.off("change")
								.val(message.payloadString)
								.flipswitch('refresh')
								.on("change", flipChanged);
								;
							}

							if (message.destinationName==NAME+"/crontab")
							{
								console.log( Base64.decode(message.payloadString));
							}
						}
					};



					client.connect(options);

					$("body").on( "flipswitchcreate",activateswitch());



					var publish = function (payload, topic, qos) {
						//Send your message (also possible to serialize it as JSON or protobuf or just use a string, no limitations)
						var message = new Messaging.Message(payload);
						message.destinationName = topic;
						//			console.log(message.destinationName);
						message.qos = qos;
						client.send(message);
					}


					$("#countdown").click(
						function(e)
						{
							e.preventDefault();
							str=$("#slider-1").val()+";"+$("#onoff").val();
							publish(str,ROOT+NAME+"/countdown",0);
							$("body").pagecontainer("change", "#main");

						}
					)

					$("#crontab").click(function(e) {
						e.preventDefault();
						offset=new Date().getTimezoneOffset();
						offset=offset/60;
						tb=$("#cronmask").val().split(" ");
						tb[1]=(parseInt(tb[1])+offset)%24;
						cronmask=tb.join(" ");
						str=cronmask+";"+$("#Conoff").val();
						publish(str,ROOT+NAME+"/timer",0);
						console.log(str);
						$("body").pagecontainer("change", "#main");
					}
				)

				$("#restart").click(
					function(e) {
						publish("reboot",ROOT+NAME+"/reboot",0);
						$("body").pagecontainer("change", "#main");
					});

				}


				$( ":mobile-pagecontainer" ).on( "pagecontainershow", function( event, ui ) {
					NAME=localStorage.param;

				});



			});



			</script>

		</body>
		</html>
