<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>New SonOFF</title>
  <!-- Bootstrap -->

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <style>
  .large { font-size:50px;}
  .black {background-color: black;}
  #pannel button { float:left; margin-right:10px;}
  </style>
</head>
<body>
  <nav class="navbar navbar-inverse">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Hack sonOff</a>
    </div>
  </nav>

  <div id="pannel" class="alert alert-success" role="alert">

    <input id="relais" type="checkbox"
    checked data-toggle="toggle"
    data-onstyle="warning"
    data-offstyle="info"
    data-width="150"
    data-height="25" hidden>
    <button id="switch"  type="button" class="btn btn-primary">
      <span class="glyphicon glyphicon-off large" aria-hidden="true"></span>
    </button>
    <div id="messages"> </div>
    <button id="conf" type="button" class="btn btn-primary">
      <span class="glyphicon glyphicon-cog
      large" aria-hidden="true"></span>
    </button>
  </div>

  <div id="myModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2>Countdown</h2>
      </div>

      <div class="modal-body">

          <input type="text" id="hh" class="form-control" placeholder="00" size=2>
          <input type="text" id="mm" class="form-control" placeholder="00" size=2>

          <select id="action">
            <option>on</option>
            <option>off</option>
          </select>


          <button id="setcount" class="btn btn-primary"><span class="glyphicon glyphicon-ok"></button>

      </div>

      <div class="modal-footer">

      </div>

    </div>
  </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="http://www.hivemq.com/demos/websocket-client/js/mqttws31.js"></script>

    <script>

    var hostname="192.168.2.30";
    var port=9001;
    var clientid="randomname"+parseInt(Math.random() * 100, 10);
    var client = new Messaging.Client(hostname, port, clientid);

    var stats = { sonoff:0 };

    var options = {
      timeout: 3,
      onSuccess: function () {
        client.subscribe("sonoff/relais", {qos: 0});
        client.subscribe("sonoff/status", {qos: 0});
      },
      onFailure: function (message) {
        alert("Connection failed: " + message.errorMessage);
      }
    };

    //Attempt to connect
    client.connect(options);


    seton=function(topic,val){
      var message = new Messaging.Message(val);
      message.destinationName = topic;
      message.qos = 0;
      return client.send(message);
    }

    $("#switch").click(function()
    {
      if (stats['sonoff']=="on")
      seton("set","0"  );
      else seton("set","1");
    });

    $("#conf").click(function()
    {

      $("#myModal").show()
    });

    $(".close").click(function() {
      $("#myModal").hide();
    });


    client.onMessageArrived = function (message) {
      //Do something with the push message you received
      if (message.destinationName=="sonoff/relais")
      {
        console.log("Switch to "+message.payloadString);
        $("#relais").prop("checked",(message.payloadString=="on"));
        stats["sonoff"]=message.payloadString;
        if (message.payloadString=="on")
        $("#pannel").addClass("alert-success")
        else {
          $("#pannel").removeClass("alert-success")
        }

      }
      //if (message.destinationName=="sonoff/status")
      $('#messages').append('<span>| ' + message.payloadString + '</span><br/>');
      $('#messages')[0].scrollTop = $('#messages')[0].scrollHeight;
    };


    $("#setcount").click(function(){
      num=0;
      if (parseInt($("#hh").val()))   num=parseInt($("#hh").val())*60
      if (parseInt($("#mm").val()))   num+=parseInt($("#mm").val())
      str=num+";"+$("#action").val()
      console.log(str);
    seton("countdown",str);
      $("#myModal").hide();
    }
  );


    </script>
    <style>
    #pannel {
      height: 10em;
    }
    #messages {
      height: 4em;
      overflow: hidden;
      float:right;
    }
    </style>

    </html>
  </body>
